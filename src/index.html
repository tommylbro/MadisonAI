<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madison AI (Offline)</title>
    <!-- Embedded Tailwind CSS -->
    <script>
        // Minified Tailwind CSS library
        // This makes the app self-contained and ready for offline use.
        window.tailwind = {
            content: [],
            theme: {
                extend: {},
            },
            plugins: [],
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Embedded React and ReactDOM CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Embedded Third-party library for markdown rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.10/marked.min.js"></script>
    
    <!-- Embedded Babel Standalone for JSX compilation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .prose-sm {
            font-size: 0.875rem;
            line-height: 1.5;
        }
        .prose-sm pre {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            white-space: pre-wrap;
        }
        .prose-sm code {
            font-size: 0.8rem;
        }
        /* No dot-flashing since there's no real AI waiting */
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="root" class="w-full h-full max-w-4xl"></div>
    <script type="text/babel">
        // This is the offline version. It uses localStorage instead of Firestore and a mock AI.

        const { useState, useEffect, useRef } = React;
        const ReactDOM = window.ReactDOM;

        // Custom Icon Components
        const BotIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "M12 8V4H8" }),
                React.createElement('rect', { width: "16", height: "12", x: "4", y: "8", rx: "2" }),
                React.createElement('path', { d: "M2 14h2" }),
                React.createElement('path', { d: "M20 14h2" }),
                React.createElement('path', { d: "M15 13l2 2" }),
                React.createElement('path', { d: "M7 13l-2 2" }),
                React.createElement('path', { d: "M12 18h.01" }),
                React.createElement('path', { d: "M7 21h10" }),
                React.createElement('path', { d: "M12 4v4" })
            )
        );

        const UserIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" }),
                React.createElement('circle', { cx: "12", cy: "7", r: "4" })
            )
        );

        const FileTextIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" }),
                React.createElement('path', { d: "M14 2v4a2 2 0 0 0 2 2h4" }),
                React.createElement('path', { d: "M10 9H8" }),
                React.createElement('path', { d: "M16 13H8" }),
                React.createElement('path', { d: "M16 17H8" })
            )
        );

        const CodeIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "m18 16 4-4-4-4" }),
                React.createElement('path', { d: "m6 8-4 4 4 4" }),
                React.createElement('path', { d: "M14.5 4l-5 16" })
            )
        );

        const WandIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "M15 14c.2-.8.8-1.5 1.7-2a4.5 4.5 0 0 0 4.3-5.4A1.68 1.68 0 0 0 21 5.3c-1.3-.1-2.6.2-3.8.9a4.5 4.5 0 0 0-4.3 5.4c-.9.9-1.6 2.4-2 3.8-.7 1.4-.2 2.8.3 3.5.7 1.3 2.1 1.6 3.8 1.6h.4c1.7 0 3.1-.3 4-.7l.3-.2" }),
                React.createElement('path', { d: "m12 10-2-2" }),
                React.createElement('path', { d: "m10 8-2-2" })
            )
        );

        // --- MOCK AI FUNCTIONALITY ---
        // This function simulates an AI response without an internet connection.
        const mockAIReply = (prompt, isCode) => {
            if (isCode) {
                return `The code you provided is a fascinating example of how a programmer might try to solve a problem. It's well-structured and uses common patterns.`;
            } else if (prompt.toLowerCase().includes("hello")) {
                return "Hello! I am an offline AI assistant. I can help with simple tasks and save our conversation locally.";
            } else if (prompt.toLowerCase().includes("how are you")) {
                return "I'm a computer program, so I'm doing great! How can I assist you?";
            } else if (prompt.toLowerCase().includes("name")) {
                return "My name is Madison AI (Offline Edition).";
            } else {
                return "I'm sorry, I'm an offline-only model and my capabilities are limited to a few pre-defined responses. I can't generate new content like my online counterpart.";
            }
        };

        const App = () => {
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([]);
            const [isAIGenerating, setIsAIGenerating] = useState(false);
            const [isCodeMode, setIsCodeMode] = useState(false);
            const messagesEndRef = useRef(null);
            const textareaRef = useRef(null);
            
            // This useEffect handles loading/saving chat history to localStorage.
            useEffect(() => {
                const savedMessages = localStorage.getItem('madison-offline-messages');
                if (savedMessages) {
                    try {
                        const parsedMessages = JSON.parse(savedMessages);
                        setMessages(parsedMessages);
                    } catch (error) {
                        console.error("Failed to parse messages from localStorage:", error);
                    }
                }
            }, []);

            // This useEffect saves messages to localStorage whenever they change.
            useEffect(() => {
                if (messages.length > 0) {
                    localStorage.setItem('madison-offline-messages', JSON.stringify(messages));
                }
                if (messagesEndRef.current) {
                    messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [messages]);

            useEffect(() => {
                const textarea = textareaRef.current;
                if (textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = `${textarea.scrollHeight}px`;
                }
            }, [input]);

            const handleSendMessage = (prompt, isCode = false) => {
                if (!prompt.trim()) return;

                // Add user message to state immediately for responsiveness
                const newUserMessage = {
                    role: 'user',
                    content: prompt,
                    isCode,
                    timestamp: new Date().toISOString(),
                };

                setMessages(prevMessages => [...prevMessages, newUserMessage]);
                setInput('');
                setIsAIGenerating(true);
                
                // Simulate a delay for the AI response
                setTimeout(() => {
                    const aiText = mockAIReply(prompt, isCode);
                    const aiMessage = {
                        role: 'ai',
                        content: aiText,
                        isCode,
                        timestamp: new Date().toISOString(),
                    };
                    setMessages(prevMessages => [...prevMessages, aiMessage]);
                    setIsAIGenerating(false);
                }, 1000); // 1 second delay
            };

            const getParsedMarkdown = (content, isCode) => {
                if (window.marked) {
                    const markdown = isCode ? '```javascript\n' + content + '\n```' : content;
                    return window.marked.parse(markdown);
                }
                return isCode ? `<pre><code>${content}</code></pre>` : `<p>${content}</p>`;
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (isCodeMode) {
                        handleSendMessage(input, true);
                    } else {
                        handleSendMessage(input, false);
                    }
                }
            };

            const handleRefineWriting = () => {
                handleSendMessage(input, false);
            };

            const handleExplainCode = () => {
                handleSendMessage(input, true);
            };

            return (
                <div className="flex flex-col h-full bg-gray-900 rounded-lg shadow-2xl overflow-hidden max-w-4xl mx-auto">
                    {/* Header */}
                    <div className="flex items-center justify-between p-4 bg-gray-800 border-b border-gray-700">
                        <div className="flex items-center space-x-2">
                            <BotIcon className="text-indigo-400" size={28} />
                            <h1 className="text-xl font-bold text-white">Madison AI (Offline)</h1>
                        </div>
                        <div className="text-xs text-gray-400">
                            Status: Offline Mode
                        </div>
                    </div>

                    {/* Chat Window */}
                    <div className="flex-1 p-4 overflow-y-auto space-y-4" style={{ WebkitOverflowScrolling: 'touch' }}>
                        {messages.length === 0 && !isAIGenerating ? (
                            <div className="text-center text-gray-500 py-10">
                                <p>Start a conversation with Madison AI.</p>
                                <p>This is the offline version. Your data is saved locally in your browser.</p>
                            </div>
                        ) : (
                            messages.map((msg, index) => (
                                <div
                                    key={index}
                                    className={`flex items-start space-x-3 ${msg.role === 'user' ? 'justify-end' : ''}`}
                                >
                                    {msg.role === 'ai' && <BotIcon className="flex-shrink-0 text-indigo-400 mt-1" />}
                                    <div className={`relative p-3 rounded-xl max-w-[80%] ${msg.role === 'user'
                                        ? 'bg-indigo-600 text-white rounded-br-none'
                                        : 'bg-gray-700 text-gray-100 rounded-bl-none'
                                        }`}>
                                        <div
                                            className="prose prose-sm prose-invert"
                                            dangerouslySetInnerHTML={{ __html: getParsedMarkdown(msg.content, msg.isCode) }}
                                        ></div>
                                    </div>
                                    {msg.role === 'user' && <UserIcon className="flex-shrink-0 text-gray-400 mt-1" />}
                                </div>
                            ))
                        )}
                        {isAIGenerating && (
                            <div className="flex items-start space-x-3">
                                <BotIcon className="flex-shrink-0 text-indigo-400 mt-1" />
                                <div className="p-3 bg-gray-700 rounded-xl rounded-bl-none">
                                    <span className="text-sm">...Thinking...</span>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <div className="p-4 bg-gray-800 border-t border-gray-700">
                        <div className="relative flex items-center bg-gray-700 rounded-full shadow-lg">
                            <textarea
                                ref={textareaRef}
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyDown={handleKeyDown}
                                className="w-full pl-6 pr-24 py-3 bg-transparent text-white placeholder-gray-400 rounded-full focus:outline-none resize-none overflow-hidden"
                                placeholder={isCodeMode ? "Enter code to explain..." : "Refine your writing..."}
                                rows={1}
                            ></textarea>
                            <div className="absolute right-2 flex items-center space-x-2">
                                <button
                                    className="p-2 bg-gray-600 text-white rounded-full shadow-lg hover:bg-gray-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center gap-1"
                                    onClick={() => setIsCodeMode(!isCodeMode)}
                                >
                                    {isCodeMode ? (
                                        <React.Fragment>
                                            <FileTextIcon size={16} />
                                            <span className="font-semibold">Writing Mode</span>
                                        </React.Fragment>
                                    ) : (
                                        <React.Fragment>
                                            <CodeIcon size={16} />
                                            <span className="font-semibold">Code Mode</span>
                                        </React.Fragment>
                                    )}
                                </button>
                                {isCodeMode ? (
                                    <button
                                        className="p-2 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center gap-1"
                                        onClick={handleExplainCode}
                                        disabled={isAIGenerating || !input.trim()}
                                    >
                                        <CodeIcon size={16} />
                                        <span className="font-semibold">✨ Explain Code</span>
                                    </button>
                                ) : (
                                    <button
                                        className="p-2 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center gap-1"
                                        onClick={handleRefineWriting}
                                        disabled={isAIGenerating || !input.trim()}
                                    >
                                        <WandIcon size={16} />
                                        <span className="font-semibold">✨ Refine Writing</span>
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(React.createElement(App, null), document.getElementById('root'));
    </script>
</body>
</html>
